---
type Lang = "es" | "en";

interface MenuItem {
    label: string;
    href?: string;
    children?: { label: string; href: string }[];
}

const menuItems: Record<Lang, MenuItem[]> = {
    es: [
        { label: "Inicio", href: "/" },
        {
            label: "Paquetes Cusco / Machu Picchu",
            children: [
                { label: "Cusco Tradicional 3D/2N", href: "/cusco-tradicional-3d-2n" },
                { label: "Cusco Sagrado 4D/3N", href: "/cusco-sagrado-4d-3n" },
                { label: "Cusco Incre칤ble 5D/4N", href: "/cusco-increible-5d-4n" },
                { label: "Cusco Maravilloso 6D/5N", href: "/cusco-maravilloso-6d-5n" },
                { label: "Cusco Sorprendente 7D/6N", href: "/cusco-sorprendente-7d-6n" },
                { label: "Cusco Extraordinario 8D/7N", href: "/cusco-extraordinario-8d-7n" },
            ],
        },
        {
            label: "Destinos Per칰",
            children: [
                { label: "Tours en Cusco", href: "/cusco" },
                { label: "Tours en Lima", href: "/lima" },
                { label: "Tours en Puno", href: "/puno" },
                { label: "Tours en Ica", href: "/ica" },
                { label: "Tours en Arequipa", href: "/arequipa" },
                { label: "Tours en Puerto Maldonado", href: "/puerto-maldonado" }
            ],
        },
        { label: "Nosotros", href: "/nosotros" },
        { label: "Galer칤a", href: "/galeria" },
    ],
    en: [
        { label: "Home", href: "/en/" },
        {
            label: "Cusco / Machu Picchu Packages",
            children: [
                { label: "Classic Cusco 5D/4N", href: "/en/packages/classic-cusco" },
                { label: "Sacred Valley + Machu Picchu", href: "/en/packages/valley-machu" },
                { label: "Adventure in Cusco", href: "/en/packages/adventure-cusco" },
            ],
        },
        {
            label: "Peru Destinations",
            children: [
                { label: "Arequipa & Colca", href: "/en/destinations/arequipa-colca" },
                { label: "Lake Titicaca", href: "/en/destinations/titicaca" },
                { label: "Amazon", href: "/en/destinations/amazon" },
            ],
        },
        { label: "About Us", href: "/en/about-us" },
        { label: "Contact Us", href: "/en/contact-us" },
    ],
};

const path = Astro.url.pathname;

// normalize hrefs & path for robust matching
function normalizeHref(h?: string) {
    if (!h) return "";
    // remove leading ./, ensure starts with '/', remove trailing slash (except root)
    let s = h.replace(/^\.\//, "/");
    if (!s.startsWith("/")) s = "/" + s;
    if (s !== "/" && s.endsWith("/")) s = s.replace(/\/+$/, "");
    return s;
}
const pathNorm = (path && path.replace(/\/+$/, "")) || "/";

function hrefMatches(h?: string) {
    if (!h) return false;
    const nh = normalizeHref(h);
    if (!nh) return false;
    if (nh === "/") return pathNorm === "/";
    return pathNorm === nh || pathNorm.startsWith(nh + "/");
}

function computeLangToggleHref(p: string, lang: Lang) {
    return lang === "es"
        ? p.startsWith("/es") ? p.replace(/^\/es/, "/en") : `/en${p}`
        : p.startsWith("/en") ? p.replace(/^\/en/, "/es") : `/es${p}`;
}
const currentLang: Lang = path.startsWith("/en") ? "en" : "es";
const langToggleHref = computeLangToggleHref(path, currentLang);
---

<nav id="navbar" class="fixed top-0 left-0 w-full bg-[#64a323]/20 backdrop-blur-md border-b border-[#64a323]/30 z-50 transition-colors duration-500 ease-in-out">
    <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between h-16">

            <!-- Logo -->
            <a href={menuItems[currentLang][0].href} class="flex items-center group">
                <img src="/logo.avif" alt="Cusco Adventure Travel Per칰" class="h-12 w-auto transition-transform duration-300 group-hover:scale-105"/>
                <div class="flex flex-col justify-center leading-none ml-1 logo-text">
                    <span class="font-bold text-lg sm:text-xl leading-none text-[#efe7da] group-hover:text-[#ffc834] transition-colors">
                        Cusco Adventure
                    </span>
                    <span class="text-sm sm:text-base tracking-wide leading-none text-[#efe7da] group-hover:text-[#ffc834] transition-colors">
                        Travel Peru
                    </span>
                </div>
            </a>

            <!-- Men칰 desktop -->
            <div class="hidden xl:flex items-center space-x-8">
                {menuItems[currentLang].map(({ label, href, children }) => {
                    const isParentActive = children ? children.some(c => hrefMatches(c.href)) : href && hrefMatches(href);
                    return children ? (
                        <div class="relative group">
                            <button class={`nav-link ${isParentActive ? "nav-active text-[#ffc834] bg-[#19470c] px-2 py-1 rounded-md" : "hover:text-[#fcd875]"} flex items-center space-x-1 font-semibold tracking-wide transition-all duration-300`} type="button">
                                <span>{label}</span>
                                <i class="fas fa-chevron-down text-xs transition-transform duration-300 group-hover:rotate-180"></i>
                            </button>

                            <div class="absolute left-0 mt-3 w-60 bg-[#19470c]/90 backdrop-blur-lg rounded-xl shadow-xl border border-[#64a323]/30 opacity-0 invisible group-hover:opacity-100 group-hover:visible group-hover:translate-y-1 transition-all duration-300 z-50">
                                {children.map((sub) => {
                                    const isChildActive = hrefMatches(sub.href);
                                    return (
                                        <a 
                                            href={sub.href} 
                                            class={`block px-5 py-3 font-medium rounded-lg transition-all duration-200 ${isChildActive ? "bg-[#efe7da] text-[#64a323] font-bold" : "text-[#efe7da] hover:bg-[#64a323]/40 hover:text-[#ffc834]"}`}
                                            aria-current={isChildActive ? "page" : null}
                                        >
                                            {sub.label}
                                        </a>
                                    );
                                })}
                            </div>
                        </div>
                    ) : (
                        (() => {
                            const isActive = href && hrefMatches(href);
                            return (
                                <a 
                                  href={href} 
                                  class={`nav-link ${isActive ? "nav-active text-[#ffc834]" : "hover:text-[#fcd875]"} relative font-semibold tracking-wide transition-all duration-300`}
                                  aria-current={isActive ? "page" : null}
                                >
                                  {label}
                                </a>
                            );
                        })()
                    );
                })}
            </div>

            <!-- Acciones (desktop) -->
            <div class="hidden xl:flex items-center space-x-4">
                <a href={langToggleHref} class="nav-link px-3 py-1 border border-[#64a323] rounded-lg hover:bg-[#ffc834] hover:text-[#19470c] transition flex items-center space-x-2 shadow-sm">
                    <img src={currentLang === "es" ? "/flags/eu.avif" : "/flags/pe.avif"} alt={currentLang === "es" ? "English" : "Espa침ol"} class="h-5 w-5"/>
                    <span class="font-bold">{currentLang === "es" ? "EN" : "ES"}</span>
                </a>
            </div>

            <!-- Bot칩n men칰 m칩vil -->
            <button id="menu-button" type="button" class="xl:hidden inline-flex items-center justify-center p-2 rounded-md nav-link hover:bg-[#64a323]/30 focus:outline-none" aria-controls="mobile-menu" aria-expanded="false">
                <svg class="h-6 w-6 text-[#efe7da]" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M4 6h16M4 12h16M4 18h16"/>
                </svg>
                <span class="sr-only">Abrir men칰</span>
            </button>
        </div>
    </div>

    <!-- Men칰 m칩vil -->
    <div id="mobile-menu" class="hidden xl:hidden flex-col px-4 pb-4 space-y-3 bg-[#64a323]/20 backdrop-blur-lg border-t border-[#64a323]/30 shadow-inner text-left">
        {menuItems[currentLang].map(({ label, href, children }) => {
            const isParentActive = children ? children.some(c => hrefMatches(c.href)) : href && hrefMatches(href);
            return children ? (
                <div class="border-b border-[#64a323]/30">
                    <button 
                      class={`w-full flex justify-between items-center py-3 font-semibold rounded-lg transition-all duration-300 ${isParentActive ? "text-[#ffc834] bg-[#64a323]/20" : "text-[#efe7da] hover:text-[#ffc834]"}`}
                      onclick="this.querySelector('i').classList.toggle('rotate-180'); this.nextElementSibling.classList.toggle('hidden')"
                      aria-expanded={isParentActive ? "true" : "false"}
                      type="button"
                    >
                        <span>{label}</span>
                        <i class={`fas fa-chevron-down transition-transform duration-300 ${isParentActive ? "rotate-180" : ""}`}></i>
                    </button>

                    <div class={`flex-col pl-4 pb-2 ${isParentActive ? "flex" : "hidden"}`}>
                        {children.map((sub) => {
                            const isChildActive = hrefMatches(sub.href);
                            return (
                                <a 
                                  href={sub.href} 
                                  class={`block py-2 transition ${isChildActive ? "text-[#ffc834] font-bold" : "text-[#efe7da] hover:text-[#ffc834]"}`}
                                  aria-current={isChildActive ? "page" : null}
                                >
                                    {sub.label}
                                </a>
                            );
                        })}
                    </div>
                </div>
            ) : (
                <a 
                  href={href} 
                  class={`block py-3 font-semibold border-b transition ${href && hrefMatches(href) ? "text-[#ffc834]" : "text-[#efe7da] hover:text-[#ffc834]"}`}
                  aria-current={href && hrefMatches(href) ? "page" : null}
                >
                  {label}
                </a>
            );
        })}

        <!-- Selector idioma m칩vil -->
        <a href={langToggleHref} class="mt-3 inline-flex w-max mx-auto items-center space-x-2 px-4 py-2 border border-[#64a323] rounded-lg hover:bg-[#64a323] hover:text-[#ffc834] transition-all shadow-sm font-bold">
            <span>{currentLang === "es" ? "游섫릖" : "游쀯릖"}</span>
            <span>{currentLang === "es" ? "EN" : "ES"}</span>
        </a>
    </div>
</nav>

<script is:inline>
    const navbar = document.getElementById("navbar");
    const btn = document.getElementById("menu-button");
    const mobileMenu = document.getElementById("mobile-menu");
    const navLinks = document.querySelectorAll(".nav-link");
    const logoText = document.querySelectorAll(".logo-text span");

    function updateNavbar() {
        const scrolled = window.scrollY > 50;

        // Fondo del navbar
        navbar.classList.toggle("nav-scrolled", scrolled);

        // Colores de los enlaces (no modificar los activos)
        navLinks.forEach(link => {
            if (link.classList.contains("nav-active")) return;  // No modificar los enlaces activos

            // Cambio de color de los enlaces seg칰n el desplazamiento
            if (scrolled) {
                link.classList.remove("text-white");
                link.classList.add("text-gray-800"); // Gris oscuro para links
                link.classList.add("hover:bg-[#fcd875]/20"); // Hover m치s suave para links
            } else {
                link.classList.remove("text-gray-800");
                link.classList.add("text-white"); // Blanco para fondo transparente
                link.classList.add("hover:bg-[#fcd875]/20"); // Hover suave en transparente
            }
        });

        // Colores del logo
        logoText.forEach(span => {
            span.classList.toggle("text-gray-800", scrolled); // Gris oscuro cuando hace scroll
            span.classList.toggle("text-white", !scrolled); // Blanco cuando no hace scroll
        });
    }

    window.addEventListener("scroll", updateNavbar);
    updateNavbar();

    // Men칰 m칩vil toggle
    if (btn && mobileMenu) {
        btn.addEventListener("click", () => {
            const isHidden = mobileMenu.classList.contains("hidden");
            mobileMenu.classList.toggle("hidden", !isHidden);
            mobileMenu.classList.toggle("flex", isHidden);
            btn.setAttribute("aria-expanded", isHidden.toString());
        });

        mobileMenu.querySelectorAll("a").forEach((link) => {
            link.addEventListener("click", () => {
                mobileMenu.classList.add("hidden");
                mobileMenu.classList.remove("flex");
                btn.setAttribute("aria-expanded", "false");
            });
        });
    }
</script>
